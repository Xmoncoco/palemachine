<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AccÃ¨s Restreint</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
    <style>
        body {
            height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Montserrat', sans-serif;
        }

        .login-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            text-align: center;
            width: 100%;
            max-width: 400px;
            backdrop-filter: blur(10px);
        }

        h1 {
            color: #4f3ca7;
            margin-bottom: 2rem;
            font-size: 1.8rem;
        }

        input[type="password"] {
            width: 100%;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1.1rem;
            box-sizing: border-box;
            transition: all 0.3s ease;
            text-align: center;
            letter-spacing: 4px;
        }

        input[type="password"]:focus {
            border-color: #764ba2;
            outline: none;
            box-shadow: 0 0 0 3px rgba(118, 75, 162, 0.1);
        }

        button {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(118, 75, 162, 0.3);
        }

        .error {
            color: #ff4757;
            margin-top: 1rem;
            font-size: 0.9rem;
            display: none;
        }
    </style>
</head>

<body>
    <div class="login-container">
        <h1>Authentification</h1>
        <form id="loginForm">
            <input type="password" id="passkey" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required autofocus>
            <button type="submit">DÃ©verrouiller</button>
            <div id="errorMsg" class="error">Code incorrect</div>
        </form>
        <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
            <button id="webauthnLogin" style="background: #fff; color: #333; border: 1px solid #ddd;">ðŸ”‘ Se connecter
                avec une Passkey</button>
        </div>
    </div>

    <script>
        // Helper to convert base64url to Uint8Array
        function base64UrlToUint8Array(base64Url) {
            const padding = '='.repeat((4 - base64Url.length % 4) % 4);
            const base64 = (base64Url + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        // Helper to convert ArrayBuffer to base64url
        function arrayBufferToBase64Url(buffer) {
            const bytes = new Uint8Array(buffer);
            let binary = '';
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        }

        document.getElementById('webauthnLogin').addEventListener('click', async () => {
            try {
                const startRes = await fetch('/auth/login_start', { method: 'POST' });
                if (!startRes.ok) throw new Error('Failed to start login');
                const options = await startRes.json();

                // Decode challenge and allowCredentials id
                options.publicKey.challenge = base64UrlToUint8Array(options.publicKey.challenge);
                if (options.publicKey.allowCredentials) {
                    options.publicKey.allowCredentials.forEach(c => {
                        c.id = base64UrlToUint8Array(c.id);
                    });
                }

                const credential = await navigator.credentials.get(options);

                const credentialData = {
                    id: credential.id,
                    rawId: arrayBufferToBase64Url(credential.rawId),
                    type: credential.type,
                    response: {
                        authenticatorData: arrayBufferToBase64Url(credential.response.authenticatorData),
                        clientDataJSON: arrayBufferToBase64Url(credential.response.clientDataJSON),
                        signature: arrayBufferToBase64Url(credential.response.signature),
                        userHandle: credential.response.userHandle ? arrayBufferToBase64Url(credential.response.userHandle) : null
                    }
                };

                const finishRes = await fetch('/auth/login_finish', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(credentialData)
                });

                if (finishRes.ok) {
                    window.location.reload();
                } else {
                    alert('Login failed');
                }
            } catch (e) {
                console.error(e);
                alert('Erreur WebAuthn: ' + e.message);
            }
        });

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const passkey = document.getElementById('passkey').value;

            try {
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ passkey })
                });

                if (response.ok) {
                    window.location.reload();
                } else {
                    const error = document.getElementById('errorMsg');
                    error.style.display = 'block';
                    error.textContent = await response.text();
                    document.getElementById('passkey').value = '';
                }
            } catch (err) {
                console.error(err);
            }
        });
    </script>
</body>

</html>