import yt_dlp
import sys
import os

def sanitize_filename(name):
    # On remplace / par _ (ou -)
    # On supprime aussi les caract√®res nuls \0 qui sont fatals
    return name.replace("/", "_").replace("\0", "")

def get_opts(path, filename_tmpl):
    """Configuration commune pour yt-dlp"""
    return {
        'format': 'bestaudio/best',
        'outtmpl': os.path.join(path, filename_tmpl),
        'quiet': False,
        'no_warnings': True,


        'postprocessors': [
            {
                # 2. Conversion en MP3
                'key': 'FFmpegExtractAudio',
                'preferredcodec': 'mp3',
                'preferredquality': '192',
            },
            {
                # 4. √âcriture des m√©tadonn√©es (Artiste, Titre, Album, etc.)
                'key': 'FFmpegMetadata',
                'add_metadata': True,
            },
        ],
    }

def download_single(url, name, base_path, artist="Unknown", album="Unknown"):
    # Structure: base_path/Artist/Album/Name.mp3
    # On nettoie les noms pour √©viter les erreurs de chemin (optionnel mais conseill√©)
    name = sanitize_filename(name)
    artist = sanitize_filename(artist)
    album = sanitize_filename(album)

    output_dir = os.path.join(base_path, artist, album)
    
    if not os.path.exists(output_dir):
        os.makedirs(output_dir, exist_ok=True)
    
    print(f"üì• T√©l√©chargement: {name} -> {output_dir}")
    
    # On force le nom du fichier final
    opts = get_opts(output_dir, f"{name}.%(ext)s")
    
    # On peut injecter les m√©tadonn√©es pour que le lecteur audio affiche les bonnes infos
    opts['postprocessors'].append({
        'key': 'FFmpegMetadata',
        'add_metadata': True,
    })

    with yt_dlp.YoutubeDL(opts) as ydl:
        ydl.download([url])
    print(output_dir)

def download_playlist(url, base_path, playlist_name):
    # Structure: base_path/Playlists/PlaylistName/Titre.mp3
    output_dir = os.path.join(base_path, "Playlists", playlist_name)

    if not os.path.exists(output_dir):
        os.makedirs(output_dir, exist_ok=True)

    print(f"saved playlist to: {output_dir}")

    # Pour une playlist, on garde le titre original de la vid√©o
    opts = get_opts(output_dir, '%(title)s.%(ext)s')

    with yt_dlp.YoutubeDL(opts) as ydl:
        ydl.download([url])
    print(output_dir)

if __name__ == "__main__":
    # Attendu: python downloader.py [mode] [url] [base_path] [args...]
    if len(sys.argv) < 4:
        print("‚ùå Arguments insuffisants")
        sys.exit(1)

    mode = sys.argv[1]
    url = sys.argv[2]
    base_path = sys.argv[3]

    try:
        if mode == "single":
            # Args: mode, url, path, name, artist, album
            if len(sys.argv) >= 7:
                name = sys.argv[4]
                artist = sys.argv[5]
                album = sys.argv[6]
                download_single(url, name, base_path, artist, album)
            else:
                print("‚ùå Arguments manquants pour le mode single (name, artist, album requis)")
                sys.exit(1)

        elif mode == "playlist":
            # Args: mode, url, path, playlist_name
            playlist_name = sys.argv[4] if len(sys.argv) > 4 else "Unknown Playlist"
            download_playlist(url, base_path, playlist_name)
        
        else:
            print(f"‚ùå Mode inconnu: {mode}")
            sys.exit(1)

    except Exception as e:
        print(f"‚ùå Erreur critique Python: {e}")
        sys.exit(1)